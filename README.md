# 嵌入式通用io数据协议框架
通过制定一套协议框架，让用户快速实现主从设备的交互，尤其是让从设备能够轻松构建服务响应（类似http）框架适用于所有支持标准io（read write）的通讯类型。可以在eiodp_config.h中配置相关接口。

数据包协议通过一个头帧+包类型来确定一个数据包。头帧为2字节：0xeb90,包类型也占2字节。而数据包尾则占4个字节。包尾根据不同的包类型来确定内容：固定尾帧、校验和、crc32。

框架会开启一个接收数据服务线程，该线程会根据接收的数据做响应的处理。（同一个硬件设备可以同时做主从，这里的主从设备是虚拟的，io必须要是双工的）

接受线程会根据TYPE的不同来进行不同的操作、发送不同的信号量、压入不同的ringbuf

数据包格式与占用长度

|  2B  |  2B  |  2B  |      nB     |      4B     |
|:----:|:----:|:----:|:-----------:|:-----------:|
| eb90 | size | TYPE |     DATA    |     CHECK   |

根据type的不同 data与check也有所不同  

其中**size = 2+n+4**

type最高位代表是发送包还是返回包，1是发送包；0是返回包  

|TYPE| bit7 | bit6 |
|-|------|------|
|1|发送包| OK  |
|0|返回包|ERROR|


## 1. 设备空间读写操作 [TYPE=0xEC01、0xEC02]
---
从设备一般会分配一些内存空间，用于记录配置与设备信息等等。主设备可以通过读写地址操作来操作从设备的空间地址数据。

### 1.1 写地址数据操作 
将长度为len字节的数据，写入从设备地址为addr往后的len位上。  
|  2B  |  2B  |  2B  |  2B  |  2B  |     lenB    |      4B     |
|------|------|------|------|------|-------------|-------------|
| eb90 | size | EC01 | addr |  len |     DATA    |     CRC32   |


### 1.2 读地址数据操作
读取从设备从addr地址往后的len位数据，该操作有返回响应。  

|  2B  |  2B  |  2B  |  2B  |  2B  |      4B     |
|------|------|------|------|------|-------------|
| eb90 | size | EC02 | addr |  len |     CRC32   |

返回正确  
|  2B  |  2B  |  2B  |  2B  |  2B  |     lenB    |      4B     |
|------|------|------|------|------|-------------|-------------|
| eb90 | size | 6C02 | addr |  len |     DATA    |     CRC32   |

返回错误，eCODE代表错误码:0x1地址非法  

|  2B  |  2B  |  2B  | 1B  |      4B     |
|------|------|------|-----|-------------|
| eb90 | size | 2C02 |eCODE|     CRC32   |


## 2. function [TYPE=0xEC03]
通用函数接口。有返回。
|  2B  |  2B  |  2B  |  2B  |  2B  |     lenB    |      4B     |
|------|------|------|------|------|-------------|-------------|
| eb90 | size | EC03 | func |  len |     arg     |     CRC32   |

返回正确

|  2B  |  2B  |  2B  |  2B  |  2B  |     lenB    |      4B     |
|------|------|------|------|------|-------------|-------------|
| eb90 | size | 6C03 | func |  len | returnDATA  |     CRC32   |

返回错误，eCODE代表错误码

|  2B  |  2B  |  2B  | 1B  |      4B     |
|------|------|------|-----|-------------|
| eb90 | size | 2C03 |eCODE|     CRC32   |
